from aiogram.types import Message, CallbackQuery
from aiogram.types.user import User

from ...utils.logger import setup_logger
from ...config.settings import settings
from ..keyboards import KeyboardBuilder

logger = setup_logger(__name__)

class EventHandlers:
    def __init__(self):
        pass

    async def handle_start(self, message: Message, user: User, to_answer: bool = True) -> None:
        try:
            user_name = user.first_name or "User"

            logger.info(f"start menu {user.id}")
            # TODO change text!!!
            welcome_text = f"""
üéØ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ project, {user_name}!**

–Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –≤—Ä–µ–º–µ–Ω–µ–º. –Ø –ø–æ–º–æ–≥–∞—é —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–±—ã—Ç–∏—è–º–∏ –ø—Ä—è–º–æ –≤ —á–∞—Ç–∞—Ö Telegram —Å —É–º–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∫–æ–º–∞–Ω–¥–æ–π `++event` –≤ –ª—é–±–æ–º —á–∞—Ç–µ
‚Ä¢ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–∞—Ç –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ
‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Apple Calendar
‚Ä¢ –£–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è-–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
‚Ä¢ –ö—Ä–∞—Å–∏–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è–º–∏

**–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:**
1. –í –ª—é–±–æ–º —á–∞—Ç–µ –≤–≤–µ–¥–∏—Ç–µ: `++event –∑–∞–≤—Ç—Ä–∞ 15:00 –í—Å—Ç—Ä–µ—á–∞ –∫–æ–º–∞–Ω–¥—ã`
2. –Ø —Å–æ–∑–¥–∞–º, –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é –∏ –∑–∞–∫—Ä–µ–ø–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ–±—ã—Ç–∏–∏
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —á–∞—Ç —Å –±–æ—Ç–æ–º –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏

–ì–æ—Ç–æ–≤—ã –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å—Å—è? üöÄ
"""
            handle_method = message.answer if to_answer else message.edit_text
            await handle_method(
                welcome_text,
                reply_markup=KeyboardBuilder.main_menu(),
                parse_mode="Markdown"
            )
        except Exception as e:
            logger.error(f"Error in start handler: {e}")
            await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")

    async def handle_help(self, message: Message, user: User, to_answer: bool = True) -> None:
        try:
            help_text = """
üìö **–ü–æ–º–æ—â—å TimeAssist**

**–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π:**
–í –ª—é–±–æ–º —á–∞—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É `++event`:

`++event –∑–∞–≤—Ç—Ä–∞ 15:00 –í—Å—Ç—Ä–µ—á–∞ –∫–æ–º–∞–Ω–¥—ã`
`++event –ø—è—Ç–Ω–∏—Ü–∞ 14:00-16:00 –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç—É --remind 1h,15m`
`++event —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ 9:00 –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø–ª–∞–Ω—ë—Ä–∫–∞`

**–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫:**
‚Ä¢ "–∑–∞–≤—Ç—Ä–∞", "–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ", "—á–µ—Ä–µ–∑ 2 —á–∞—Å–∞"
‚Ä¢ "15:00-16:00" –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
‚Ä¢ "--remind 30m,1h" –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

**–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:**
‚Ä¢ `/events` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è–º–∏
‚Ä¢ `/settings` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚Ä¢ `/sync` - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Apple Calendar
‚Ä¢ `/help` - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
‚Ä¢ üìå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
‚Ä¢ üîî –£–º–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
‚Ä¢ üìÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Apple Calendar
‚Ä¢ ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/–ø–µ—Ä–µ–Ω–æ—Å —Å–æ–±—ã—Ç–∏–π
‚Ä¢ üéØ 48-—á–∞—Å–æ–≤–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
"""
            handle_method = message.answer if to_answer else message.edit_text
            await handle_method(
                help_text,
                reply_markup=KeyboardBuilder.help_menu(),
                parse_mode="Markdown"
            )
        except Exception as e:
            logger.error(f"Error in help handler: {e}")
            await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
